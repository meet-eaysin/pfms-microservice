# Development environment with hot-reload and debug utilities
# Extends docker-compose.base.yml with development-only services

services:
  # Add debug logging to all per-service PostgreSQL instances
  postgres-auth:
    environment:
      POSTGRES_INITDB_ARGS: '-c log_statement=all'

  postgres-expense:
    environment:
      POSTGRES_INITDB_ARGS: '-c log_statement=all'

  postgres-user:
    environment:
      POSTGRES_INITDB_ARGS: '-c log_statement=all'

  postgres-income:
    environment:
      POSTGRES_INITDB_ARGS: '-c log_statement=all'

  postgres-investment:
    environment:
      POSTGRES_INITDB_ARGS: '-c log_statement=all'

  postgres-loan:
    environment:
      POSTGRES_INITDB_ARGS: '-c log_statement=all'

  # Email Testing UI
  mailhog:
    image: mailhog/mailhog:latest
    container_name: pfms_mailhog
    ports:
      - '1025:1025' # SMTP
      - '8025:8025' # Web UI
    networks:
      - pfms_network

  # API Gateway (Kong) - Uses its own database for configuration
  kong-db:
    image: postgres:16-alpine
    container_name: pfms_kong_db
    environment:
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong
      POSTGRES_DB: kong
    volumes:
      - kong_db_data:/var/lib/postgresql/data
    networks:
      - pfms_network

  kong:
    image: kong:latest
    container_name: pfms_kong
    environment:
      KONG_DATABASE: 'off'
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    ports:
      - '8000:8000' # Kong Proxy
    volumes:
      - ./config/kong.yml:/kong/declarative/kong.yml
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    depends_on:
      - kong-db
    healthcheck:
      test: ['CMD', 'kong', 'health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pfms_network

  # Kong UI - Admin Console
  konga:
    image: pantsel/konga:latest
    container_name: pfms_konga
    environment:
      NODE_ENV: development
      DB_ADAPTER: postgres
      DB_HOST: kong-db
      DB_USER: kong
      DB_PASSWORD: kong
      DB_DATABASE: kong
    # Port exposed only within Docker network (internal access)
    depends_on:
      - kong-db
      - kong
    networks:
      - pfms_network

  # Portainer - Container Management UI (Optional)
  portainer:
    image: portainer/portainer-ce:latest
    container_name: pfms_portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    # Ports exposed only within Docker network (internal access)
    networks:
      - pfms_network

volumes:
  kong_db_data:
  portainer_data:
