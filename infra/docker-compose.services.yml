# PFMS Services - Main Docker Compose
# Use this with -f flag to combine with base.yml and dev.yml if needed
# Example: docker compose -f docker-compose.base.yml -f docker-compose.dev.yml -f docker-compose.services.yml up -d

services:
  # ========================================
  # MICROSERVICES (All 14 Services)
  # ========================================

  # 1. Auth Service (Port 3001, NestJS)
  auth-service:
    container_name: pfms_auth_service
    build:
      context: ..
      dockerfile: apps/auth-service/Dockerfile
    environment:
      NODE_ENV: production
      SERVICE_NAME: auth-service
      SERVICE_PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_AUTH_USER:-postgres}:${POSTGRES_AUTH_PASSWORD:-postgres_dev_password}@postgres-auth:5432/auth_db
      DATABASE_HOST: postgres-auth
      DATABASE_PORT: 5432
      DATABASE_NAME: auth_db
      DATABASE_USER: ${POSTGRES_AUTH_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_AUTH_PASSWORD:-postgres_dev_password}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_dev_password}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-rabbitmq_dev_password}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRY: 24h
      LOG_LEVEL: info
      ENABLE_SWAGGER: 'false'
    # Port 3001 is internal only - access via Kong on port 8000
    # ports:
    #   - "3001:3001"
    depends_on:
      postgres-auth:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3001/api/v1/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    # Production mode - use CMD from Dockerfile (node dist/main.js)
    # volumes:
    #   - ../apps/auth-service/src:/app/src
    # command: npm run dev

    # 2. User Service (Port 3002, NestJS)
  user-service:
    container_name: pfms_user_service
    build:
      context: ../apps/user-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: user-service
      SERVICE_PORT: 3002
      DATABASE_HOST: postgres-user
      DATABASE_PORT: 5432
      DATABASE_NAME: user_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3002:3002'
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3002/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/user-service/src:/app/src

  # 3. Expense Service (Port 3003, Express.js)
  # Production-Ready: No exposed ports, internal network only
  expense-service:
    container_name: pfms_expense_service
    build:
      context: ..
      dockerfile: apps/expense-service/Dockerfile
      target: runner
    environment:
      NODE_ENV: production
      SERVICE_NAME: expense-service
      SERVICE_PORT: 3003
      DATABASE_URL: postgresql://${POSTGRES_EXPENSE_USER:-postgres}:${POSTGRES_EXPENSE_PASSWORD:-postgres_dev_password}@postgres-expense:5432/expense_db
      DATABASE_HOST: postgres-expense
      DATABASE_PORT: 5432
      DATABASE_NAME: expense_db
      DATABASE_USER: ${POSTGRES_EXPENSE_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_EXPENSE_PASSWORD:-postgres_dev_password}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_dev_password}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-rabbitmq_dev_password}
      LOG_LEVEL: info
    # NO PORT EXPOSURE - Internal Docker network only
    # External access ONLY via Kong Gateway (port 8000)
    depends_on:
      postgres-expense:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      kong:
        condition: service_healthy
    networks:
      - pfms_network
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3003/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 4. Income Service (Port 3004, Express.js)
  income-service:
    container_name: pfms_income_service
    build:
      context: ../apps/income-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: income-service
      SERVICE_PORT: 3004
      DATABASE_HOST: postgres-income
      DATABASE_PORT: 5432
      DATABASE_NAME: income_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3004:3004'
    depends_on:
      postgres-income:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3004/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/income-service/src:/app/src

  # 5. Investment Service (Port 3005, Express.js)
  investment-service:
    container_name: pfms_investment_service
    build:
      context: ../apps/investment-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: investment-service
      SERVICE_PORT: 3005
      DATABASE_HOST: postgres-investment
      DATABASE_PORT: 5432
      DATABASE_NAME: investment_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3005:3005'
    depends_on:
      postgres-investment:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3005/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/investment-service/src:/app/src

  # 6. Loan Service (Port 3006, NestJS)
  loan-service:
    container_name: pfms_loan_service
    build:
      context: ../apps/loan-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: loan-service
      SERVICE_PORT: 3006
      DATABASE_HOST: postgres-loan
      DATABASE_PORT: 5432
      DATABASE_NAME: loan_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3006:3006'
    depends_on:
      postgres-loan:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3006/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/loan-service/src:/app/src

  # 7. Group Service (Port 3007, Express.js)
  group-service:
    container_name: pfms_group_service
    build:
      context: ../apps/group-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: group-service
      SERVICE_PORT: 3007
      DATABASE_HOST: postgres-user
      DATABASE_PORT: 5432
      DATABASE_NAME: group_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3007:3007'
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3007/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/group-service/src:/app/src

  # 8. Tax Service (Port 3008, Express.js)
  tax-service:
    container_name: pfms_tax_service
    build:
      context: ../apps/tax-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: tax-service
      SERVICE_PORT: 3008
      DATABASE_HOST: postgres-user
      DATABASE_PORT: 5432
      DATABASE_NAME: tax_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3008:3008'
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3008/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/tax-service/src:/app/src

  # 9. AI/Analytics Service (Port 3009, Express.js)
  ai-service:
    container_name: pfms_ai_service
    build:
      context: ../apps/ai-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: ai-service
      SERVICE_PORT: 3009
      MONGODB_HOST: mongodb
      MONGODB_PORT: 27017
      MONGODB_NAME: ai_analytics_db
      MONGODB_USER: root
      MONGODB_PASSWORD: root
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3009:3009'
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3009/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/ai-service/src:/app/src

  # 10. Notification Service (Port 3010, Express.js)
  notification-service:
    container_name: pfms_notification_service
    build:
      context: ../apps/notification-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: notification-service
      SERVICE_PORT: 3010
      DATABASE_HOST: postgres-user
      DATABASE_PORT: 5432
      DATABASE_NAME: notification_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3010:3010'
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      mailhog:
        condition: service_started
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3010/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/notification-service/src:/app/src

  # 11. Automation Service (Port 3011, NestJS)
  automation-service:
    container_name: pfms_automation_service
    build:
      context: ../apps/automation-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: automation-service
      SERVICE_PORT: 3011
      DATABASE_HOST: postgres-user
      DATABASE_PORT: 5432
      DATABASE_NAME: automation_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3011:3011'
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3011/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/automation-service/src:/app/src

  # 12. Report Service (Port 3012, Express.js)
  report-service:
    container_name: pfms_report_service
    build:
      context: ../apps/report-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: report-service
      SERVICE_PORT: 3012
      DATABASE_HOST: postgres-user
      DATABASE_PORT: 5432
      DATABASE_NAME: report_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      STORAGE_TYPE: local
      LOCAL_STORAGE_PATH: /app/uploads
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3012:3012'
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3012/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/report-service/src:/app/src
      - ./uploads:/app/uploads

  # 13. Market Data Service (Port 3013, Express.js)
  market-service:
    container_name: pfms_market_service
    build:
      context: ../apps/market-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: market-service
      SERVICE_PORT: 3013
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3013:3013'
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3013/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/market-service/src:/app/src

  # 14. Savings/Goals Service (Port 3014, Express.js)
  savings-service:
    container_name: pfms_savings_service
    build:
      context: ../apps/savings-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      SERVICE_NAME: savings-service
      SERVICE_PORT: 3014
      DATABASE_HOST: postgres-user
      DATABASE_PORT: 5432
      DATABASE_NAME: savings_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      LOG_LEVEL: debug
      ENABLE_SWAGGER: 'true'
    ports:
      - '3014:3014'
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pfms_network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3014/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ../apps/savings-service/src:/app/src
  # ========================================
  # MONITORING & OBSERVABILITY (Defined in base.yml)
  # ========================================
